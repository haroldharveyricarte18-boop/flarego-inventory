<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flarego Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--text-main);
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        /* Notification Styles */
        .notif-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .bell-btn {
            background: white;
            border: 1px solid var(--border);
            width: 42px;
            height: 42px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            transition: all 0.2s;
        }

        .bell-btn:hover { background: #f1f5f9; }

        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            display: none; 
        }

        .notif-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            display: none;
            z-index: 101;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .notif-item {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .notif-item:hover { background: #f8fafc; }
        .notif-item.unread { border-left: 4px solid var(--primary); background: #f5f7ff; }
        .notif-item .time { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 4px; }

        /* User Section */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            cursor: pointer;
            padding: 5px 12px;
            border-radius: 12px;
            transition: background 0.2s;
        }

        .user-section:hover { background: #f1f5f9; }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px; 
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            background: #eee;
        }

        .user-meta { text-align: right; }
        .user-meta .name { display: block; font-weight: 700; font-size: 0.9rem; color: var(--dark); }
        .user-meta .role { 
            display: block; 
            font-size: 0.7rem; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 220px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            display: none;
            z-index: 100;
            margin-top: 10px;
            overflow: hidden;
        }

        .profile-dropdown a {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-main);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .profile-dropdown a:hover { background: #f8fafc; color: var(--primary); }

        .alert-banner {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            color: var(--danger);
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 18px; 
        }
        
        .logo-container {
            width: 62px;
            height: 62px;
            background: var(--primary);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 24px -6px rgba(99, 102, 241, 0.4);
        }

        .brand-text {
            margin: 0;
            font-weight: 800;
            font-size: 2.4rem;
            color: var(--dark);
            letter-spacing: -1.8px;
            line-height: 1;
        }

        .brand-text span { color: var(--primary); }

        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 0.8fr 1fr 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 40px; 
        }

        .stat-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .stat-card h4 { margin: 0; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 1.3rem; font-weight: 800; margin-top: 8px; color: var(--dark); }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.39); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }

        .btn-outline { border: 2px solid #e2e8f0; color: var(--text-main); background: white; }
        .btn-outline:hover { background: #f8fafc; border-color: #cbd5e1; }

        .btn-sell {
            background: #ecfdf5;
            color: var(--success);
            border: 1px solid #d1fae5;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-sell:hover:not(:disabled) { background: var(--success); color: white; }
        .btn-sell:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); 
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .inventory-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sorting-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 200px;
            padding: 10px 24px;
            background: #fcfdfe;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .sort-btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .sort-btn:hover { color: var(--primary); }

        .product-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 200px; 
            padding: 16px 24px;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        .product-row:hover { 
            background: #f8fafc; 
            border-left: 4px solid var(--primary);
        }

        .product-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            align-items: center;
        }

        .product-row:hover .product-actions {
            opacity: 1;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
        }

        .status-ok { background: #ecfdf5; color: var(--success); }
        .status-low { background: #fff7ed; color: var(--warning); }
        .status-critical { background: #fef2f2; color: var(--danger); }

        .form-section { padding: 30px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        
        /* New Broadcast Section Styling */
        .broadcast-section {
            padding: 30px;
            background: #f5f7ff;
            border-bottom: 2px solid var(--primary);
            animation: slideDown 0.3s ease-out;
        }

        input, textarea { 
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #cbd5e1; 
            box-sizing: border-box; font-family: inherit; font-size: 0.95rem;
        }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-muted); }

        .btn-view-all {
            display: block;
            width: 100%;
            text-align: center;
            padding: 12px;
            text-decoration: none;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 700;
            background: #f8fafc;
            border-top: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .btn-view-all:hover { background: #f1f5f9; }

        .pagination-footer {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-top: 1px solid #f1f5f9;
        }
        
        .jump-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .jump-input {
            width: 50px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: 700;
        }

        .btn-pagination {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-main);
        }
        .btn-pagination:hover:not(:disabled) {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
        }
        .btn-pagination:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Sidebar Styling */
.sidebar {
    position: fixed;
    top: 0;
    left: -280px; /* Hidden by default */
    width: 280px;
    height: 100%;
    background: white;
    box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
    display: flex;
    flex-direction: column;
}

/* When the sidebar is toggled open */
.sidebar.active {
    left: 0;
}

/* Overlay to dim the background */
.nav-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(2px);
    display: none;
    z-index: 1000;
}

.nav-overlay.active {
    display: block;
}

/* Hamburger Button Icon */
.hamburger-btn {
    display: flex;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    margin-right: 15px;
}

.hamburger-btn span {
    display: block;
    width: 24px;
    height: 2px;
    background: var(--dark);
    border-radius: 2px;
    transition: 0.3s;
}

/* Sidebar Menu Items */
.menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    text-decoration: none;
    color: #475569;
    border-radius: 10px;
    font-weight: 500;
    transition: 0.2s;
    margin-bottom: 4px;
}

.menu-item:hover {
    background: #f1f5f9;
    color: var(--primary);
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f1f5f9;
}

    </style>
</head>
<body>
   <body>
    <div class="nav-overlay" id="navOverlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 1.2rem; margin:0; color:var(--dark);">Flarego <span>Tools</span></h2>
            <button onclick="toggleSidebar()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <nav>
            <a href="/" class="menu-item">üìä Dashboard</a>
            {{ if eq .User.Role "admin" }}
                <a href="javascript:void(0)" onclick="toggleForm(); toggleSidebar()" class="menu-item">‚ûï New Product</a>
                <a href="/export" class="menu-item">üì• Export CSV</a>
                <a href="javascript:void(0)" onclick="toggleBroadcast(); toggleSidebar()" class="menu-item">üì¢ Broadcast System</a>
                <a href="/users" class="menu-item">üë• User Management</a>
                <a href="/audit" class="menu-item">üìú Audit Trail</a>
            {{ end }}
            <a href="/settings" class="menu-item">‚öôÔ∏è Profile Settings</a>
            <hr style="border: 0; border-top: 1px solid #f1f5f9; margin: 20px 0;">
            <a href="/logout" class="menu-item" style="color: var(--danger);">üö™ Logout</a>
        </nav>
    </aside>

    <div class="container">
        
        {{$lowStockItems := ""}}
        {{range .Products}}{{if le .NumericStock 5}}{{$lowStockItems = print $lowStockItems .Name ", "}}{{end}}{{end}}
        {{if ne $lowStockItems ""}}
        <div class="alert-banner">
            <span>‚ö†Ô∏è</span>
            <span>Low Stock Alert: {{ $lowStockItems }} need restocking.</span>
        </div>
        {{end}}

        <div class="top-bar">
            <div class="brand">
                <button class="hamburger-btn" onclick="toggleSidebar()">
                    <span></span><span></span><span></span>
                </button>
                <div class="logo-container">
                    <svg width="32" height="32" viewBox="0 0 200 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M95.5 10C95.5 10 50 60 50 145C50 215 95 255 110 255C125 255 170 215 170 145C170 75 120 10 120 10C120 10 150 50 150 125C150 185 115 220 115 220C115 220 80 185 80 125C80 65 110 10 110 10" fill="white"/>
                    </svg>
                </div>
                <h1 class="brand-text">Flare<span>go</span></h1>
            </div>

            <div style="display: flex; gap: 24px; align-items: center;">
                <div class="notif-wrapper">
                    <button class="bell-btn" id="notifBtn" onclick="toggleNotifDropdown(event)">
                        üîî <span id="notifBadge" class="notif-badge">0</span>
                    </button>
                    <div id="notifDropdown" class="notif-dropdown">
                        <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <strong style="font-size: 0.9rem;">Notifications</strong>
                            <a href="javascript:void(0)" onclick="clearNotifications()" style="font-size: 0.7rem; color: var(--primary); text-decoration: none;">Clear all</a>
                        </div>
                        <div id="notifList">
                            <div id="notifEmptyState" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">No new notifications</div>
                        </div>
                    </div>
                </div>

                <div class="user-section" id="userBtn" onclick="toggleProfileDropdown(event)">
                    <div class="user-meta">
                        <span class="name">{{.User.DisplayName}}</span>
                        <span class="role">{{ if eq .User.Role "admin" }}Administrator{{ else }}Staff Member{{ end }}</span>
                    </div>
                    <img src="{{if .User.ProfilePic}}{{.User.ProfilePic}}{{else}}https://ui-avatars.com/api/?name={{.User.DisplayName}}&background=6366f1&color=fff{{end}}" 
                         class="avatar" alt="Profile">
                    
                    <div id="profileDropdown" class="profile-dropdown">
                        <a href="/settings">‚öôÔ∏è Profile Settings</a>
                        <a href="/logout" style="color: var(--danger);">üö™ Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px;"><canvas id="healthChart"></canvas></div>
                <div>
                    <h4>Health</h4>
                    <div class="value">{{.HealthScore}}%</div>
                </div>
            </div>
            <div class="stat-card">
                <h4>Total Units</h4>
                <div class="value">{{.TotalStockItems}}</div>
            </div>
            <div class="stat-card" style="border-bottom: 4px solid var(--primary);">
                <h4>Sales Today</h4> <div class="value">{{.TotalSales}}</div>
            </div>
            <div class="stat-card">
                <h4>Valuation</h4>
                <div class="value">‚Ç±{{.TotalValue}}</div> 
            </div>
            <div class="stat-card">
                <h4>Est. Profit</h4>
                <div class="value" style="color: var(--success);">‚Ç±{{.TotalProfit}}</div> 
            </div>
        </div>

        <div class="main-layout">
            </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('navOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // Keep your existing renderInventory and other functions here...
    </script>
</body>

    <script>
        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredProducts = [];
        let sortState = { column: null, direction: 'asc' };
        let unreadCount = 0;

        const allProducts = [
            {{range .Products}}
            {
                id: "{{.ID}}",
                name: "{{.Name}}",
                desc: "{{.Desc}}",
                stock: {{.NumericStock}},
                displayStock: "{{.Stock}}",
                price: parseFloat("{{.Price}}".replace(/,/g, ''))
            },
            {{end}}
        ];

        filteredProducts = [...allProducts];

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredProducts.slice(startIndex, endIndex);

            if (pageItems.length === 0) {
                list.innerHTML = `<div style="padding: 60px; text-align: center; color: var(--text-muted);">No products found.</div>`;
            } else {
                list.innerHTML = pageItems.map(p => `
                    <div class="product-row">
                        <div>
                            <div style="font-weight: 700; color: var(--dark);">${p.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${p.desc}</div>
                        </div>
                        <div>
                            <span class="status-badge ${p.stock <= 0 ? 'status-critical' : p.stock <= 5 ? 'status-low' : 'status-ok'}">
                                ${p.displayStock} Units
                            </span>
                        </div>
                        <div style="font-weight: 800;">‚Ç±${p.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                        
                        <div class="product-actions">
                            <form action="/sell" method="POST" style="margin:0;">
                                <input type="hidden" name="id" value="${p.id}">
                                <button type="submit" class="btn-sell" ${p.stock <= 0 ? 'disabled title="Out of Stock"' : ''}>üí∞ SELL</button>
                            </form>
                            
                            {{ if eq $.User.Role "admin" }}
                            <a href="/?edit=${p.id}" style="color: var(--primary); text-decoration: none; font-size: 0.8rem; font-weight: 700;">Edit</a>
                            <a href="/delete?id=${p.id}" onclick="return confirm('Delete this product?')" style="color: var(--danger); text-decoration: none; font-size: 0.8rem; font-weight: 700;">Del</a>
                            {{ end }}
                        </div>
                    </div>
                `).join('');
            }

            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage) || 1;
            document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            document.getElementById('jumpPageInput').max = totalPages;
        }

        // --- Notification UI Handlers ---
        function toggleNotifDropdown(e) {
            e.stopPropagation();
            const d = document.getElementById('notifDropdown');
            const p = document.getElementById('profileDropdown');
            if(p) p.style.display = 'none';
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
            
            if(d.style.display === 'block') {
                unreadCount = 0;
                updateBadge();
            }
        }

        function toggleProfileDropdown(e) {
            e.stopPropagation();
            const d = document.getElementById('profileDropdown');
            const n = document.getElementById('notifDropdown');
            if(n) n.style.display = 'none';
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        }

        window.onclick = function(event) {
            if (!event.target.closest('.notif-wrapper') && !event.target.closest('.user-section')) {
                const nd = document.getElementById('notifDropdown');
                const pd = document.getElementById('profileDropdown');
                if(nd) nd.style.display = 'none';
                if(pd) pd.style.display = 'none';
            }
        }

        // --- BROADCAST HANDLERS ---
        function toggleBroadcast() {
            const panel = document.getElementById('broadcast-panel');
            const dropdown = document.getElementById('profileDropdown');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            dropdown.style.display = 'none'; // Close dropdown after clicking
            if(panel.style.display === 'block') panel.scrollIntoView({ behavior: 'smooth' });
        }

        function postBroadcast() {
            const title = document.getElementById('bcTitle').value;
            const message = document.getElementById('bcMessage').value;

            if(!title || !message) {
                alert("Please fill in both title and message.");
                return;
            }

            fetch('/api/send-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
            })
            .then(res => {
                if(res.ok) {
                    alert("Broadcast Sent!");
                    document.getElementById('bcTitle').value = '';
                    document.getElementById('bcMessage').value = '';
                    document.getElementById('broadcast-panel').style.display = 'none';
                } else {
                    alert("Error sending broadcast.");
                }
            });
        }

        function addNotification(title, message) {
            const list = document.getElementById('notifList');
            const empty = document.getElementById('notifEmptyState');
            if(empty) empty.remove();

            const item = document.createElement('div');
            item.className = 'notif-item unread';
            item.innerHTML = `
                <strong style="font-size: 0.85rem; display: block;">${title}</strong>
                <span style="font-size: 0.8rem; color: var(--text-muted);">${message}</span>
                <span class="time">Just now</span>
            `;
            list.prepend(item);
            
            unreadCount++;
            updateBadge();
        }

        function updateBadge() {
            const badge = document.getElementById('notifBadge');
            badge.innerText = unreadCount;
            badge.style.display = unreadCount > 0 ? 'block' : 'none';
        }

        function clearNotifications() {
            document.getElementById('notifList').innerHTML = `<div id="notifEmptyState" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">No new notifications</div>`;
            unreadCount = 0;
            updateBadge();
        }

        const evtSource = new EventSource("/events");
        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            addNotification(data.title, data.message);
        };

        function toggleSort(col) {
            if (sortState.column === col) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = col;
                sortState.direction = 'asc';
            }
            
            ['name', 'stock', 'price'].forEach(c => {
                document.getElementById(`sort-${c}`).innerText = '‚Üï';
            });
            document.getElementById(`sort-${col}`).innerText = sortState.direction === 'asc' ? '‚Üë' : '‚Üì';

            filteredProducts.sort((a, b) => {
                let valA = a[col];
                let valB = b[col];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderInventory();
        }

        function changePage(dir) {
            currentPage += dir;
            renderInventory();
        }

        function handleJump(e) {
            if (e.key === 'Enter') {
                const page = parseInt(e.target.value);
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderInventory();
                }
            }
        }

        document.getElementById('posSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filteredProducts = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.desc.toLowerCase().includes(term)
            );
            currentPage = 1;
            renderInventory();
        });

        function toggleForm() {
            const form = document.getElementById('form-content');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        const healthCtx = document.getElementById('healthChart').getContext('2d');
        new Chart(healthCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [{{.HealthScore}}, 100-{{.HealthScore}}],
                    backgroundColor: ['#6366f1', '#e2e8f0'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '75%', plugins: { tooltip: { enabled: false } } }
        });

        renderInventory();
    </script>
</body>
</html>