<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flarego Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --nav-height: 70px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--text-main);
            line-height: 1.6;
            padding-top: var(--nav-height);
        }

        /* --- New Clean Navbar Styles --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            z-index: 1000;
            padding: 0 40px;
        }

        .nav-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left, .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* --- End Navbar Styles --- */

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        .notif-wrapper { position: relative; display: flex; align-items: center; }

        .bell-btn {
            background: white;
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            position: relative;
            transition: all 0.2s;
        }

        .bell-btn:hover { background: #f1f5f9; border-color: var(--primary); }

        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.6rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            display: none; 
        }

        .notif-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            display: none;
            z-index: 101;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .notif-item { padding: 15px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
        .notif-item:hover { background: #f8fafc; }
        .notif-item.unread { border-left: 4px solid var(--primary); background: #f5f7ff; }
        .notif-item .time { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 4px; }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 12px;
            transition: background 0.2s;
        }

        .user-section:hover { background: #f1f5f9; }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 10px; 
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: #eee;
        }

        .user-meta { text-align: right; }
        .user-meta .name { display: block; font-weight: 700; font-size: 0.85rem; color: var(--dark); line-height: 1.2; }
        .user-meta .role { 
            display: block; 
            font-size: 0.65rem; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 220px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            display: none;
            z-index: 100;
            margin-top: 15px;
            overflow: hidden;
        }

        .profile-dropdown a {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-main);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .profile-dropdown a:hover { background: #f8fafc; color: var(--primary); }

        .alert-banner {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            color: var(--danger);
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            text-decoration: none;
        }
        
        .logo-container {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .brand-text {
            margin: 0;
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--dark);
            letter-spacing: -1px;
            line-height: 1;
        }

        .brand-text span { color: var(--primary); }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 20px; 
            margin-bottom: 40px; 
        }

        .stat-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .stat-card h4 { margin: 0; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card .value { font-size: 1.3rem; font-weight: 800; margin-top: 8px; color: var(--dark); }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            border: none;
            font-size: 0.85rem;
        }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .btn-outline { border: 1px solid #e2e8f0; color: var(--text-main); background: white; }
        .btn-outline:hover { background: #f8fafc; border-color: var(--primary); color: var(--primary); }

        .btn-sell {
            background: #ecfdf5;
            color: var(--success);
            border: 1px solid #d1fae5;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-sell:hover:not(:disabled) { background: var(--success); color: white; }
        .btn-sell:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); 
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .inventory-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sorting-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 200px;
            padding: 10px 24px;
            background: #fcfdfe;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .sort-btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.2s;
        }

        .sort-btn:hover { color: var(--primary); }

        .product-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 200px; 
            padding: 16px 24px;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        .product-row:hover { 
            background: #f8fafc; 
            border-left: 4px solid var(--primary);
        }

        .product-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            align-items: center;
        }

        .product-row:hover .product-actions { opacity: 1; }

        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
        }

        .status-ok { background: #ecfdf5; color: var(--success); }
        .status-low { background: #fff7ed; color: var(--warning); }
        .status-critical { background: #fef2f2; color: var(--danger); }

        .form-section { padding: 30px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        
        .broadcast-section {
            padding: 30px;
            background: #f5f7ff;
            border-bottom: 2px solid var(--primary);
            animation: slideDown 0.3s ease-out;
        }

        input, textarea { 
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #cbd5e1; 
            box-sizing: border-box; font-family: inherit; font-size: 0.95rem;
        }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text-muted); }

        .btn-view-all {
            display: block;
            width: 100%;
            text-align: center;
            padding: 12px;
            text-decoration: none;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 700;
            background: #f8fafc;
            border-top: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .btn-view-all:hover { background: #f1f5f9; }

        .pagination-footer {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-top: 1px solid #f1f5f9;
        }
        
        .jump-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .jump-input {
            width: 50px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: 700;
        }

        .btn-pagination {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-main);
        }
        .btn-pagination:hover:not(:disabled) {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
        }
        .btn-pagination:disabled { opacity: 0.4; cursor: not-allowed; }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .main-layout { grid-template-columns: 1fr; }
            .navbar { padding: 0 20px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-left">
                <a href="/" class="brand">
                    <div class="logo-container">
                        <svg width="24" height="24" viewBox="0 0 200 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M95.5 10C95.5 10 50 60 50 145C50 215 95 255 110 255C125 255 170 215 170 145C170 75 120 10 120 10C120 10 150 50 150 125C150 185 115 220 115 220C115 220 80 185 80 125C80 65 110 10 110 10" fill="white"/>
                        </svg>
                    </div>
                    <h1 class="brand-text">Flare<span>go</span></h1>
                </a>
            </div>

            <div class="nav-right">
                <div style="display: flex; gap: 10px;">
                    {{ if eq .User.Role "admin" }}
                    <a href="/export" class="btn btn-outline">üì• Export</a>
                    <button onclick="toggleForm()" class="btn btn-primary">‚ûï New Product</button>
                    {{ end }}
                </div>

                <div class="notif-wrapper">
                    <button class="bell-btn" id="notifBtn" onclick="toggleNotifDropdown(event)">
                        üîî <span id="notifBadge" class="notif-badge">0</span>
                    </button>
                    <div id="notifDropdown" class="notif-dropdown">
                        <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <strong style="font-size: 0.9rem;">Notifications</strong>
                            <a href="javascript:void(0)" onclick="clearNotifications()" style="font-size: 0.7rem; color: var(--primary); text-decoration: none;">Clear all</a>
                        </div>
                        <div id="notifList">
                            <div id="notifEmptyState" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">No new notifications</div>
                        </div>
                    </div>
                </div>

                <div class="user-section" id="userBtn" onclick="toggleProfileDropdown(event)">
                    <div class="user-meta">
                        <span class="name">{{.User.DisplayName}}</span>
                        <span class="role">{{ if eq .User.Role "admin" }}Admin{{ else }}Staff{{ end }}</span>
                    </div>
                    <img src="{{if .User.ProfilePic}}{{.User.ProfilePic}}{{else}}https://ui-avatars.com/api/?name={{.User.DisplayName}}&background=6366f1&color=fff{{end}}" 
                         class="avatar" 
                         alt="Profile" 
                         onerror="this.src='https://ui-avatars.com/api/?name={{.User.DisplayName}}&background=6366f1&color=fff'">
                    
                    <div id="profileDropdown" class="profile-dropdown">
                        <a href="/settings">‚öôÔ∏è Profile Settings</a>
                        {{ if eq .User.Role "admin" }}
                        <a href="javascript:void(0)" onclick="toggleBroadcast()" style="background: #f5f7ff; color: var(--primary);">üì¢ Broadcast System</a>
                        <a href="/users">üë• User Management</a>
                        <a href="/audit">üìú Audit Trail</a>
                        {{ end }}
                        <hr style="border: 0; border-top: 1px solid #f1f5f9; margin: 0;">
                        <a href="/logout" style="color: var(--danger);">üö™ Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        
        {{$lowStockItems := ""}}
        {{range .Products}}{{if le .NumericStock 5}}{{$lowStockItems = print $lowStockItems .Name ", "}}{{end}}{{end}}
        
        {{if ne $lowStockItems ""}}
        <div class="alert-banner">
            <span>‚ö†Ô∏è</span>
            <span>Low Stock Alert: {{ $lowStockItems }} need restocking.</span>
        </div>
        {{end}}

        <div class="stats-grid">
            <div class="stat-card" style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px;"><canvas id="healthChart"></canvas></div>
                <div>
                    <h4>Health</h4>
                    <div class="value">{{.HealthScore}}%</div>
                </div>
            </div>
            <div class="stat-card">
                <h4>Total Units</h4>
                <div class="value">{{.TotalStockItems}}</div>
            </div>
            <div class="stat-card" style="border-bottom: 4px solid var(--primary);">
                <h4>Sales Today</h4> <div class="value">{{.TotalSales}}</div>
            </div>
            <div class="stat-card">
                <h4>Valuation</h4>
                <div class="value">‚Ç±{{.TotalValue}}</div> 
            </div>
            <div class="stat-card">
                <h4>Est. Profit</h4>
                <div class="value" style="color: var(--success);">‚Ç±{{.TotalProfit}}</div> 
            </div>
        </div>

        <div class="main-layout">
            <div class="card">
                {{ if eq .User.Role "admin" }}
                <div id="form-content" class="form-section" style="display: {{if .IsEditing}}block{{else}}none{{end}};">
                    <h3 style="margin-top:0">{{if .EditItem}}Edit Product: {{.EditItem.Name}}{{else}}Add New Product{{end}}</h3>
                    <form action="/add" method="POST">
                        <input type="hidden" name="id" value="{{if .EditItem}}{{.EditItem.ID}}{{end}}">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                            <div class="input-group">
                                <label>Product Name</label>
                                <input type="text" name="name" value="{{if .EditItem}}{{.EditItem.Name}}{{end}}" required>
                            </div>
                            <div class="input-group">
                                <label>Price (Sell) ‚Ç±</label>
                                <input type="number" step="0.01" name="price" value="{{if .EditItem}}{{.EditItem.Price}}{{end}}" required>
                            </div>
                            <div class="input-group">
                                <label>Cost (Buy) ‚Ç±</label>
                                <input type="number" step="0.01" name="cost_price" value="{{if .EditItem}}{{.EditItem.CostPrice}}{{end}}" required>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 15px; margin-top: 15px;">
                            <div class="input-group">
                                <label>Stock</label>
                                <input type="number" name="stock" value="{{if .EditItem}}{{.EditItem.Stock}}{{end}}" required>
                            </div>
                            <div class="input-group">
                                <label>Description</label>
                                <input type="text" name="desc" value="{{if .EditItem}}{{.EditItem.Desc}}{{end}}" required>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">{{if .EditItem}}Update Product{{else}}Save Product{{end}}</button>
                            <a href="/" class="btn btn-outline">Cancel</a>
                        </div>
                    </form>
                </div>

                <div id="broadcast-panel" class="broadcast-section" style="display: none;">
                    <h3 style="margin-top:0; color: var(--primary);">üõ†Ô∏è Admin Settings: Broadcast Update</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">Send a real-time notification to all logged-in staff members.</p>
                    <div style="display: grid; grid-template-columns: 1fr 2fr 150px; gap: 15px; align-items: end;">
                        <div class="input-group">
                            <label>Update Title</label>
                            <input type="text" id="bcTitle" placeholder="e.g. Schedule Change">
                        </div>
                        <div class="input-group">
                            <label>Message to all staff...</label>
                            <input type="text" id="bcMessage" placeholder="Type your announcement here...">
                        </div>
                        <button onclick="postBroadcast()" class="btn btn-primary" style="width: 100%;">Post Update</button>
                    </div>
                </div>
                {{ end }}

                <div class="inventory-header">
                    <h3 style="margin:0">Live Inventory</h3>
                    <input type="text" id="posSearch" placeholder="Search products..." style="width: 250px;">
                </div>

                <div class="sorting-row">
                    <div class="sort-btn" onclick="toggleSort('name')">Product Name <span id="sort-name">‚Üï</span></div>
                    <div class="sort-btn" onclick="toggleSort('stock')">Stock <span id="sort-stock">‚Üï</span></div>
                    <div class="sort-btn" onclick="toggleSort('price')">Price <span id="sort-price">‚Üï</span></div>
                    <div style="text-align: right;">Actions</div>
                </div>

                <div id="inventory-list"></div>

                <div class="pagination-footer">
                    <div>
                        <button class="btn-pagination" id="prevBtn" onclick="changePage(-1)">‚Üê Previous</button>
                        <span id="pageIndicator" style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin: 0 10px;">Page 1 of 1</span>
                        <button class="btn-pagination" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
                    </div>
                    
                    <div class="jump-container">
                        Jump to Page: 
                        <input type="number" id="jumpPageInput" class="jump-input" min="1" onkeypress="handleJump(event)">
                    </div>
                </div>
            </div>

            <div class="card" style="display: flex; flex-direction: column;">
                <div style="padding: 24px 24px 12px 24px;">
                    <h3 style="margin-top: 0; font-size: 1rem;">Recent Activity</h3>
                </div>
                <div style="padding: 0 24px; flex-grow: 1;">
                    {{range .Logs}}
                    <div style="padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem;">
                        <div style="font-weight: 700; color: {{if eq .Action "Sale"}}var(--success){{else}}var(--primary){{end}}; font-size: 0.7rem; text-transform: uppercase;">{{.Action}}</div>
                        <div style="font-weight: 600;">{{.ProductName}}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">{{.CreatedAt.Format "Jan 02, 15:04"}}</div>
                    </div>
                    {{else}}
                    <p style="font-size: 0.8rem; color: var(--text-muted);">No recent logs.</p>
                    {{end}}
                </div>
                {{ if eq .User.Role "admin" }}
                <a href="/audit" class="btn-view-all">VIEW ALL HISTORY ‚Üí</a>
                {{ end }}
            </div>
        </div>

        <p style="text-align:center; font-size: 0.8rem; color: var(--text-muted); margin-top: 40px;">
            <b>Flarego ERP v3.0</b> ‚Ä¢ POS Enabled ‚Ä¢ Role-Based Access
        </p>
    </div>

    <script>
        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredProducts = [];
        let sortState = { column: null, direction: 'asc' };
        let unreadCount = 0;

        const allProducts = [
            {{range .Products}}
            {
                id: "{{.ID}}",
                name: "{{.Name}}",
                desc: "{{.Desc}}",
                stock: {{.NumericStock}},
                displayStock: "{{.Stock}}",
                price: parseFloat("{{.Price}}".replace(/,/g, ''))
            },
            {{end}}
        ];

        filteredProducts = [...allProducts];

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredProducts.slice(startIndex, endIndex);

            if (pageItems.length === 0) {
                list.innerHTML = `<div style="padding: 60px; text-align: center; color: var(--text-muted);">No products found.</div>`;
            } else {
                list.innerHTML = pageItems.map(p => `
                    <div class="product-row">
                        <div>
                            <div style="font-weight: 700; color: var(--dark);">${p.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${p.desc}</div>
                        </div>
                        <div>
                            <span class="status-badge ${p.stock <= 0 ? 'status-critical' : p.stock <= 5 ? 'status-low' : 'status-ok'}">
                                ${p.displayStock} Units
                            </span>
                        </div>
                        <div style="font-weight: 800;">‚Ç±${p.price.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                        
                        <div class="product-actions">
                            <form action="/sell" method="POST" style="margin:0;">
                                <input type="hidden" name="id" value="${p.id}">
                                <button type="submit" class="btn-sell" ${p.stock <= 0 ? 'disabled title="Out of Stock"' : ''}>üí∞ SELL</button>
                            </form>
                            
                            {{ if eq $.User.Role "admin" }}
                            <a href="/?edit=${p.id}" style="color: var(--primary); text-decoration: none; font-size: 0.8rem; font-weight: 700;">Edit</a>
                            <a href="/delete?id=${p.id}" onclick="return confirm('Delete this product?')" style="color: var(--danger); text-decoration: none; font-size: 0.8rem; font-weight: 700;">Del</a>
                            {{ end }}
                        </div>
                    </div>
                `).join('');
            }

            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage) || 1;
            document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            document.getElementById('jumpPageInput').max = totalPages;
        }

        function toggleNotifDropdown(e) {
            e.stopPropagation();
            const d = document.getElementById('notifDropdown');
            const p = document.getElementById('profileDropdown');
            if(p) p.style.display = 'none';
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
            
            if(d.style.display === 'block') {
                unreadCount = 0;
                updateBadge();
            }
        }

        function toggleProfileDropdown(e) {
            e.stopPropagation();
            const d = document.getElementById('profileDropdown');
            const n = document.getElementById('notifDropdown');
            if(n) n.style.display = 'none';
            d.style.display = d.style.display === 'block' ? 'none' : 'block';
        }

        window.onclick = function(event) {
            if (!event.target.closest('.notif-wrapper') && !event.target.closest('.user-section')) {
                const nd = document.getElementById('notifDropdown');
                const pd = document.getElementById('profileDropdown');
                if(nd) nd.style.display = 'none';
                if(pd) pd.style.display = 'none';
            }
        }

        function toggleBroadcast() {
            const panel = document.getElementById('broadcast-panel');
            const dropdown = document.getElementById('profileDropdown');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            dropdown.style.display = 'none'; 
            if(panel.style.display === 'block') panel.scrollIntoView({ behavior: 'smooth' });
        }

        function postBroadcast() {
    const title = document.getElementById('bcTitle').value;
    const message = document.getElementById('bcMessage').value;

    if(!title || !message) {
        alert("Please fill in both title and message.");
        return;
    }

    fetch('/api/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `title=${encodeURIComponent(title)}&message=${encodeURIComponent(message)}`
    })
    .then(res => {
        if(res.ok) {
            // Clear inputs and hide panel after successful send
            document.getElementById('bcTitle').value = '';
            document.getElementById('bcMessage').value = '';
            document.getElementById('broadcast-panel').style.display = 'none';
        } else {
            alert("Failed to send broadcast. Check server connection.");
        }
    });
}
        function addNotification(title, message) {
    const list = document.getElementById('notifList');
    const empty = document.getElementById('notifEmptyState');
    
    // Remove the "No new notifications" text if it exists
    if(empty) empty.style.display = 'none';

    const item = document.createElement('div');
    item.className = 'notif-item unread';
    const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    item.innerHTML = `
        <strong style="font-size: 0.85rem; display: block;">${title}</strong>
        <span style="font-size: 0.8rem; color: var(--text-muted);">${message}</span>
        <span class="time">${now}</span>
    `;
    list.prepend(item); // Adds newest update to the top
}

        function updateBadge() {
            const badge = document.getElementById('notifBadge');
            badge.innerText = unreadCount;
            badge.style.display = unreadCount > 0 ? 'block' : 'none';
        }

        function clearNotifications() {
            document.getElementById('notifList').innerHTML = `<div id="notifEmptyState" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">No notifications</div>`;
            unreadCount = 0;
            updateBadge();
        }

        function toggleForm() {
            const f = document.getElementById('form-content');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
            if(f.style.display === 'block') f.scrollIntoView({ behavior: 'smooth' });
        }

        function toggleSort(col) {
            if (sortState.column === col) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = col;
                sortState.direction = 'asc';
            }

            ['name', 'stock', 'price'].forEach(c => {
                document.getElementById(`sort-${c}`).innerText = '‚Üï';
            });
            document.getElementById(`sort-${col}`).innerText = sortState.direction === 'asc' ? '‚Üë' : '‚Üì';

            filteredProducts.sort((a, b) => {
                let valA = a[col], valB = b[col];
                if (col === 'name') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderInventory();
        }

        function changePage(dir) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage) || 1;
            currentPage += dir;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            renderInventory();
        }

        function handleJump(e) {
            if (e.key === 'Enter') {
                const val = parseInt(e.target.value);
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage) || 1;
                if (val >= 1 && val <= totalPages) {
                    currentPage = val;
                    renderInventory();
                } else {
                    alert(`Please enter a page between 1 and ${totalPages}`);
                }
            }
        }

        document.getElementById('posSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            filteredProducts = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.desc.toLowerCase().includes(term)
            );
            currentPage = 1;
            renderInventory();
        });

        // Chart Initialization
        const ctx = document.getElementById('healthChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [{{.HealthScore}}, 100 - {{.HealthScore}}],
                    backgroundColor: ['#6366f1', '#e2e8f0'],
                    borderWidth: 0,
                    weight: 0.5
                }]
            },
            options: {
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });

        // Initial render
        renderInventory();

        // This connects to your server's broadcast stream
const socket = new WebSocket('ws://' + window.location.host + '/ws/notifications');

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    // 1. Run the builder we fixed in Step 1
    addNotification(data.title, data.message);
    
    // 2. Increment the red badge count
    unreadCount++;
    updateBadge();
};

function updateBadge() {
    const badge = document.getElementById('notifBadge');
    badge.innerText = unreadCount;
    // Show badge only if there are unread items
    badge.style.display = unreadCount > 0 ? 'block' : 'none';
}
    </script>
</body>
</html>